<!DOCTYPE html>
<html ng-app="AngujarJS">
<head>
    <title>Debug Update</title>
    <link rel="stylesheet" href="vendor/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
    <style>
        body { padding: 20px; }
        .form-group { margin: 10px 0; }
        .btn { margin: 5px; }
        .debug-output { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; }
    </style>
</head>
<body ng-controller="DebugUpdateCtrl">
    <h1>Debug Update</h1>
    
    <div class="form-group">
        <h3>Formulario de Prueba</h3>
        <form name="testForm" ng-submit="testUpdate()" novalidate>
            <div class="form-group">
                <label>ID:</label>
                <input type="text" ng-model="test_id" class="form-control" placeholder="ID" value="1">
            </div>
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="view_nombre" ng-model="view_nombre" class="form-control" placeholder="Nombre">
            </div>
            <div class="form-group">
                <label>Descripción:</label>
                <input type="text" id="view_descripcion" ng-model="view_descripcion" class="form-control" placeholder="Descripción">
            </div>
            <div class="form-group">
                <label>Bonificación:</label>
                <input type="text" id="view_bonificacion_editar" ng-model="view_bonificacion" class="form-control" placeholder="Bonificación">
            </div>
            <button type="submit" class="btn btn-primary">Probar Update</button>
            <button type="button" class="btn btn-warning" ng-click="testFields()">Probar Campos</button>
        </form>
    </div>
    
    <div id="debug-output" class="debug-output">
        <h4>Debug Output:</h4>
        <div id="debug-content"></div>
    </div>
    
    <script src="vendor/angular/angular.min.js"></script>
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/bootstrap.min.js"></script>
    <script src="vendor/sweetalert2/sweetalert2.min.js"></script>
    
    <script>
        angular.module('AngujarJS', [])
        .controller('DebugUpdateCtrl', function($scope, $http) {
            $scope.test_id = 1;
            $scope.view_nombre = '';
            $scope.view_descripcion = '';
            $scope.view_bonificacion = '';
            
            function log(message) {
                console.log(message);
                document.getElementById('debug-content').innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            }
            
            // Función para sanitizar bonificación (copiada de jerarquia.js)
            $scope.sanitizeBonificacion = function () {
                if ($scope.view_bonificacion != null) {
                    var valor = parseInt($scope.view_bonificacion);
                    if (!isNaN(valor) && valor >= 0) {
                        $scope.view_bonificacion = valor;
                    }
                }
            };
            
            // Función para validar bonificación (copiada de jerarquia.js)
            $scope.validateBonificacion = function() {
                var bonificacion = parseInt($scope.view_bonificacion);
                return !isNaN(bonificacion) && bonificacion >= 0;
            };
            
            $scope.testUpdate = function() {
                log('=== PROBANDO UPDATE ===');
                
                // Obtener valores de los campos correctos para edición
                var nombreField = document.getElementById('view_nombre');
                var descripcionField = document.getElementById('view_descripcion');
                var bonificacionField = document.getElementById('view_bonificacion_editar');
                
                log('Campos encontrados:');
                log('- view_nombre: ' + (nombreField ? 'SÍ' : 'NO'));
                log('- view_descripcion: ' + (descripcionField ? 'SÍ' : 'NO'));
                log('- view_bonificacion_editar: ' + (bonificacionField ? 'SÍ' : 'NO'));
                
                if (nombreField) log('Valor nombre: ' + nombreField.value);
                if (descripcionField) log('Valor descripción: ' + descripcionField.value);
                if (bonificacionField) log('Valor bonificación: ' + bonificacionField.value);
                
                // Obtener valores
                $scope.view_nombre = nombreField ? nombreField.value : $scope.view_nombre;
                $scope.view_descripcion = descripcionField ? descripcionField.value : $scope.view_descripcion;
                $scope.view_bonificacion = bonificacionField ? bonificacionField.value : $scope.view_bonificacion;
                
                log('Valores obtenidos:');
                log('- Nombre: ' + $scope.view_nombre);
                log('- Descripción: ' + $scope.view_descripcion);
                log('- Bonificación: ' + $scope.view_bonificacion);
                
                // Validar y sanitizar bonificación
                $scope.sanitizeBonificacion();
                log('Después de sanitizar: ' + $scope.view_bonificacion);
                
                // Verificar que la bonificación sea válida
                if (!$scope.validateBonificacion()) {
                    log('ERROR: Validación falló');
                    return;
                }
                
                log('Validación exitosa');
                
                // Simular envío
                var jsonForm = {
                    id: $scope.test_id,
                    nombre: $scope.view_nombre,
                    descripcion: $scope.view_descripcion,
                    bonificacion: $scope.view_bonificacion
                };
                
                log('JSON a enviar: ' + JSON.stringify(jsonForm));
                
                // Intentar envío real
                $http({
                    method: 'post',
                    headers: {
                        "Content-Type": "application/json; charset=utf-8",
                        "Authorization": ""
                    },
                    url: 'http://localhost:8000/api/jerarquia/Update',
                    data: jsonForm
                }).then(function (success) {
                    log('Respuesta del servidor: ' + JSON.stringify(success));
                    log('Update exitoso');
                }, function (error) {
                    log('Error del servidor: ' + JSON.stringify(error));
                    log('Update falló');
                });
            };
            
            $scope.testFields = function() {
                log('=== PROBANDO CAMPOS ===');
                var nombre = document.getElementById('view_nombre');
                var descripcion = document.getElementById('view_descripcion');
                var bonificacion = document.getElementById('view_bonificacion_editar');
                
                log('Campos encontrados: ' + (nombre ? 'SÍ' : 'NO') + ', ' + (descripcion ? 'SÍ' : 'NO') + ', ' + (bonificacion ? 'SÍ' : 'NO'));
                if (nombre) log('Valor nombre: ' + nombre.value);
                if (descripcion) log('Valor descripción: ' + descripcion.value);
                if (bonificacion) log('Valor bonificación: ' + bonificacion.value);
            };
            
            // Interceptar console.log
            var originalLog = console.log;
            console.log = function(message) {
                originalLog.apply(console, arguments);
                if (typeof message === 'string' && (message.includes('PROBANDO') || message.includes('Campos') || message.includes('Valores') || message.includes('JSON'))) {
                    document.getElementById('debug-content').innerHTML += '<div style="color: blue;">' + message + '</div>';
                }
            };
            
            // Inicializar cuando la página cargue
            document.addEventListener('DOMContentLoaded', function() {
                log('Página de debug cargada');
            });
        });
    </script>
</body>
</html>

